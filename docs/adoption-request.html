<!DOCTYPE html>
<head>
    <link rel="stylesheet" href="first-page.css">
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
      crossorigin="anonymous"
    />
    <script
      src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"
      crossorigin="anonymous"
    ></script>
    <script src="js/nav-loader.js"></script>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-light bg-light mb-0">
        <a class="navbar-brand" href="index.html"><img src="website-logo.png" class="website-logo"/></a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        </nav>

    <div class="website-bg pt-5 pl-4" id="sectionAdoptionRequest">
        <h1 class="find-companion text-center">Adoption Request</h1>
        <p class="find-companion-caption text-center">Ready to welcome a new friend? Fill out the form below</p>

        <div class="container mt-4 adoption-form-card p-4 shadow">
            <h3 class="mb-3 text-center">Adoption Request Form</h3>
            <form id="adoptionForm" autocomplete="off"> 
                <input type="hidden" id="userIdHidden" name="user_id">
                
                <div class="mb-3">
                    <label for="fullName" class="form-label">Full Name</label>
                    <input type="text" class="form-control" id="fullName" name="fullName" placeholder="John Doe" autocomplete="off" value="">
                    <small class="form-text text-muted">Automatically populated after login.</small>
                </div>

                <div class="mb-3">
                    <label for="adoptionEmailField" class="form-label">Email</label>
                    <input type="text" 
                           class="form-control" 
                           id="adoptionEmailField" 
                           name="email_address" 
                           placeholder="john.doe@example.com" 
                           autocomplete="off" 
                           value="">
                </div>

                <div class="mb-3">
                    <label for="phone" class="form-label">Phone Number</label>
                    <input type="tel" class="form-control" id="phone" name="phone" placeholder="(123) 456-7890">
                </div>

                <div class="mb-3">
                    <label for="petId" class="form-label">Pet ID</label>
                    <input type="text" class="form-control" id="petId" name="petId" placeholder="e.g., 2 for Bella">
                </div>

                <div class="mb-3">
                    <label for="address" class="form-label">Address</label>
                    <input type="text" class="form-control" id="address" name="address" placeholder="123 Main St, Anytown, USA">
                </div>

                <div class="mb-3">
                    <label for="reason" class="form-label">Why do you want to adopt this pet?</label>
                    <textarea class="form-control" id="reason" name="reason" rows="4" placeholder="Tell us about your home and why you'd be a great pet parent"></textarea>
                </div>

                <button type="submit" class="submit-button">
                    üêæ Submit Request
                </button>
            </form>
        </div>
    </div>


<script>
    const API_BASE_URL = 'http://localhost:3000/api';

    // Helper to fetch user email/details for form population
    function fetchUserDetails(userId) {
        fetch(`${API_BASE_URL}/user/${userId}`)
            .then(response => response.json())
            .then(data => {
                const emailInput = document.getElementById('adoptionEmailField');
                const fullNameInput = document.getElementById('fullName');

                if (data.email) {
                    // Update field value with actual user email fetched from server
                    emailInput.value = data.email;
                    fullNameInput.value = data.name || '';
                    
                    // Restore type="email" for client-side validation
                    emailInput.type = 'email'; 
                    
                    // Lock fields to prevent user editing
                    emailInput.setAttribute('readonly', true); 
                    fullNameInput.setAttribute('readonly', true); 
                }
            })
            .catch(error => console.error('Failed to fetch user email:', error));
    }

    // --- Adoption Request Handler (CRITICAL) ---
    function handleAdoptionSubmit(event) {
        event.preventDefault(); 

        const form = event.target;
        
        // Collect email value from the input's final value
        const emailValue = document.getElementById('adoptionEmailField').value.trim();

        const formData = {
            fullName: form.fullName.value.trim(),
            email: emailValue, // Sent to backend
            phone: form.phone.value.trim(),
            petId: form.petId.value.trim(),
            address: form.address.value.trim(),
            reason: form.reason.value.trim(),
            user_id: form.user_id.value
        };
        
        if (!formData.petId || !formData.reason) {
            alert('Please enter a Pet ID and a reason for adoption.');
            return;
        }

        fetch(`${API_BASE_URL}/adoption-request`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData),
        })
        .then(response => {
            if (!response.ok) {
                 return response.json().then(errorData => {
                    throw new Error(errorData.message || 'Adoption submission failed.');
                });
            }
            return response.json();
        })
        .then(data => {
            alert(data.message);
            if (data.message.includes('successfully')) {
                form.reset();
            }
        })
        .catch(error => {
            console.error('Adoption Fetch Error:', error);
            alert(error.message); 
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        const userId = localStorage.getItem('userId');
        const fullNameInput = document.getElementById('fullName');
        const emailInput = document.getElementById('adoptionEmailField');
        
        // --- 1. Aggressive Clear on Load ---
        // These run instantly to defeat the browser's autofill routine.
        fullNameInput.value = ''; 
        emailInput.value = '';
        
        // Give the browser 50ms to finish its autofill routines, then check auth
        setTimeout(() => {
            
            if (!userId) {
                // 2. AUTH FAIL: If logged out, deny access and redirect
                alert('Please log in to submit an adoption request.');
                window.location.href = 'login.html';
                return;
            }

            // 3. AUTH SUCCESS: Pre-populate and fetch email
            document.getElementById('userIdHidden').value = userId;
            
            // 4. Fetch email from server (This fills the input if logged in)
            fetchUserDetails(userId); 

            const adoptionForm = document.getElementById('adoptionForm');
            
            if (adoptionForm) {
                adoptionForm.addEventListener('submit', handleAdoptionSubmit);
            }

        }, 50); 
    });
</script>
</body>
</html>